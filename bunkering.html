<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bunkering Cost Trade-off â€” Baselines (Sum) vs Alternatives</title>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2a;
      --muted: #9fb0d1;
      --text: #e8eefc;
    }

    * {
      box-sizing: border-box
    }

    body {
      font-family: Pretendard, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif;
      margin: 0;
      background: linear-gradient(180deg, #0a0f1c, #0d1526);
      color: var(--text)
    }

    header {
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(8px);
      background: rgba(10, 15, 28, .6);
      border-bottom: 1px solid rgba(255, 255, 255, .06)
    }

    header .wrap {
      display: flex;
      align-items: center;
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px
    }

    h1 {
      font-size: 22px;
      margin: 0 8px 0 0
    }

    .container {
      max-width: 1280px;
      margin: 20px auto 80px;
      padding: 0 16px
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px
    }

    @media(max-width: 1100px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    .card {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .35)
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px
    }

    .subtle {
      color: var(--muted);
      font-size: 13px
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed
    }

    th,
    td {
      border-bottom: 1px solid rgba(255, 255, 255, .06);
      padding: 8px;
      text-align: left;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    thead th {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em
    }

    input,
    select {
      width: 100%;
      background: #0e1627;
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none
    }

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .row-actions {
      display: flex;
      gap: 8px;
      justify-content: center
    }

    .btn {
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, .12);
      background: #0e1627;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
      white-space: nowrap
    }

    .btn:hover {
      background: #111b30
    }

    .btn.ghost {
      background: transparent;
      border-color: rgba(255, 255, 255, .2)
    }

    .chip {
      background: #0e1627;
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px
    }

    .kpi {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px
    }

    .kpi .chip strong {
      display: block;
      font-size: 14px
    }

    .right {
      text-align: right
    }

    .small {
      font-size: 12px;
      color: var(--muted)
    }

    .mt8 {
      margin-top: 8px
    }

    .mt12 {
      margin-top: 12px
    }

    .mt16 {
      margin-top: 16px
    }

    .scroll {
      max-height: 320px;
      overflow: auto;
      border: 1px solid rgba(255, 255, 255, .06);
      border-radius: 12px
    }

    .pill {
      font-size: 11px;
      color: #cfe1ff;
      background: #0f1d3a;
      border: 1px solid rgba(255, 255, 255, .08);
      padding: 2px 8px;
      border-radius: 999px
    }

    .preset {
      font-size: 11px;
      color: #b9c8e8
    }

    /* Wider column widths for readability */
    #tblBase th:nth-child(1),
    #tblBase td:nth-child(1) {
      width: 170px
    }

    #tblBase th:nth-child(2),
    #tblBase td:nth-child(2) {
      width: 120px
    }

    #tblBase th:nth-child(3),
    #tblBase td:nth-child(3) {
      width: 140px
    }

    #tblBase th:nth-child(4),
    #tblBase td:nth-child(4) {
      width: 240px
    }

    #tblBase th:nth-child(5),
    #tblBase td:nth-child(5) {
      width: 150px
    }

    #tblBase th:nth-child(6),
    #tblBase td:nth-child(6) {
      width: 150px
    }

    #tblBase th:nth-child(7),
    #tblBase td:nth-child(7) {
      width: 120px
    }

    #tblBase th:nth-child(8),
    #tblBase td:nth-child(8) {
      width: 120px
    }

    #tblBase th:nth-child(9),
    #tblBase td:nth-child(9) {
      width: 90px
    }

    #tblFuel th:nth-child(1),
    #tblFuel td:nth-child(1) {
      width: 190px
    }

    #tblFuel th:nth-child(2),
    #tblFuel td:nth-child(2) {
      width: 120px
    }

    #tblFuel th:nth-child(3),
    #tblFuel td:nth-child(3) {
      width: 130px
    }

    #tblFuel th:nth-child(4),
    #tblFuel td:nth-child(4) {
      width: 220px
    }

    #tblFuel th:nth-child(5),
    #tblFuel td:nth-child(5) {
      width: 140px
    }

    #tblFuel th:nth-child(6),
    #tblFuel td:nth-child(6) {
      width: 140px
    }

    #tblFuel th:nth-child(7),
    #tblFuel td:nth-child(7) {
      width: 120px
    }

    #tblFuel th:nth-child(8),
    #tblFuel td:nth-child(8) {
      width: 110px
    }

    #tblFuel th:nth-child(9),
    #tblFuel td:nth-child(9) {
      width: 80px
    }

    #tblFuel th:nth-child(10),
    #tblFuel td:nth-child(10) {
      width: 70px
    }

    /* test panel */
    #testPanel {
      background: #0e1627;
      border: 1px dashed rgba(255, 255, 255, .2);
      border-radius: 12px;
      padding: 12px;
      margin-top: 16px
    }

    #testPanel pre {
      max-height: 200px;
      overflow: auto;
      margin: 0
    }

    /* market table */
    #tblMarket th:nth-child(1) {
      width: 170px
    }

    #tblMarket th:nth-child(2),
    #tblMarket td:nth-child(2) {
      width: 130px
    }

    #tblMarket th:nth-child(3),
    #tblMarket td:nth-child(3) {
      width: 140px
    }

    #tblMarket th:nth-child(4),
    #tblMarket td:nth-child(4) {
      width: 280px
    }

    #tblMarket th:nth-child(5),
    #tblMarket td:nth-child(5) {
      width: 120px
    }

    .hidden {
      visibility: hidden;
      position: absolute;
      left: -9999px;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <h1>Bunkering Cost Trade-off</h1>
      <span class="subtle">ê¸°ì¤€ ì—°ë£Œ(ì—¬ëŸ¬ í–‰) <strong>í•©ê³„</strong> vs ëŒ€ì•ˆ ì—°ë£Œ â€” ì—°ë£Œ í”„ë¦¬ë¯¸ì—„ê³¼ íƒ„ì†Œ ì ˆê°ì˜ ìƒì‡„ í‰ê°€</span>
      <div style="flex:1"></div>
      <button class="btn ghost" id="exportJson">ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <label class="btn ghost" for="importJsonInput">ë¶ˆëŸ¬ì˜¤ê¸°(JSON)</label>
      <input id="importJsonInput" type="file" accept="application/json" style="display:none" />
    </div>
  </header>

  <div class="container">
    <!-- Market reference prices -->
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px">
      <section class="card">
        <h2>ğŸ“ˆ í˜„ì¬ ì‹œì„¸(ì°¸ê³ ) & í™˜ìœ¨</h2>
        <div class="small">ì•„ë˜ ìˆ˜ì¹˜ëŠ” ì˜¤ëŠ˜ ê¸°ì¤€ ì™¸ë¶€ ì¶œì²˜ë¥¼ ì°¸ê³ í•´ **ìŠ¤ëƒ…ìƒ·**ìœ¼ë¡œ ë„£ì—ˆìŠµë‹ˆë‹¤. í™˜ìœ¨(USDâ†’KRW)ì€ í¸ì§‘ ê°€ëŠ¥í•˜ë©°, USD ë‹¨ê°€ë„ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        <div class="row-actions mt8" style="gap:12px; align-items:center">
          <button class="btn" id="btnMarketAdd">+ ì‹œì„¸ í–‰ ì¶”ê°€</button>
          <div class="chip">í™˜ìœ¨(1 USD â†’ KRW): <input id="fxUSDKRW" type="number" step="1" min="500" value="1404"
              style="width:120px; margin-left:6px" /></div>
          <div class="chip">ë‹¨ìœ„: $/mt ê¸°ì¤€ (â€» LNGëŠ” 11.05 $/MMBtu â†’ **52 MMBtu/mt ê°€ì •**)</div>
          <div class="chip">ê¸°ì¤€ì¼: <span id="marketAsOf">2025-10-02</span></div>
        </div>
        <div class="scroll mt8">
          <table id="tblMarket">
            <thead>
              <tr>
                <th>ìœ ì¢…</th>
                <th>USD/mt</th>
                <th>KRW/mt</th>
                <th>ì¶œì²˜</th>
                <th>í–‰ ì¶”ê°€</th>
              </tr>
            </thead>
            <tbody id="marketBody"></tbody>
          </table>
        </div>
        <div class="row-actions mt12" style="justify-content:flex-start; gap:8px">
          <button class="btn" id="btnCalcVolBase">ê¸°ì¤€(annual) ì‚¬ìš©ëŸ‰ ì‚°ì¶œ</button>
          <button class="btn" id="btnCalcVolAlt">ëŒ€ì•ˆ(annual) ì‚¬ìš©ëŸ‰ ì‚°ì¶œ</button>
          <button class="btn ghost" id="btnCalcVolAll">ëª¨ë‘ ì‚°ì¶œ</button>
        </div>
        <div class="small mt8">* ìˆ˜ì†Œ(Hydrogen)ëŠ” ê³µê°œ ì§€ìˆ˜(HYDRIX)ê°€ ì£¼ê°„/ì§€ì—­ ê¸°ì¤€ì´ë¼ **í‘œì‹œëŠ” ë¹„ì›Œë‘ê³  í¸ì§‘**í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.</div>
      </section>
      <section class="card">
        <h2>ì—ë„ˆì§€ íš¨ìœ¨(MMBtu/mt)</h2>
        <div class="small">ì—°ë£Œë³„ ì—ë„ˆì§€ íš¨ìœ¨ì„ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì¦‰ì‹œ ë°˜ì˜)</div>
        <div class="scroll mt8">
          <table id="tblEnergy">
            <thead>
              <tr>
                <th>ìœ ì¢…</th>
                <th>ì—ë„ˆì§€ íš¨ìœ¨ (MMBtu/mt)</th>
              </tr>
            </thead>
            <tbody id="energyBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <section class="card">
      <h2>ê¸°ì¤€ ì—°ë£Œ(í•©ê³„ ë°˜ì˜)</h2>
      <div class="small">ì—¬ê¸°ì— ì¶”ê°€ëœ ëª¨ë“  <strong>ê¸°ì¤€ ì—°ë£Œ í–‰ì˜ í•©ê³„</strong>ê°€ ë¹„êµì˜ ê¸°ì¤€ì´ ë©ë‹ˆë‹¤. (ì¶”ê°€/ì‚­ì œ/ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ ëŒ€ì•ˆê³¼ ë™ì¼)</div>
      <div class="row-actions mt8">
        <button class="btn" id="btnAddBaseVLSFO">+ ê¸°ì¤€ VLSFO (ì €ìœ í™©ìœ )</button>
        <button class="btn" id="btnAddBaseMGO">+ ê¸°ì¤€ MGO (ê²½ìœ )</button>
        <button class="btn ghost" id="btnAddBaseCustom">+ ê¸°ì¤€ ì‚¬ìš©ì ì§€ì •</button>
      </div>
      <div class="scroll mt8">
        <table id="tblBase">
          <thead>
            <tr>
              <th>ìœ ì¢…</th>
              <th>ì—°ê°„ ì‚¬ìš©ëŸ‰ (í†¤)</th>
              <th>ëª¨ë“œ</th>
              <th>ë‹¨ê°€(â‚©/í†¤) ë˜ëŠ” ì—°ê°„ë¹„ìš© í‰ê· (â‚©)</th>
              <th>ë°°ì¶œê³„ìˆ˜ (tCOâ‚‚/í†¤)</th>
              <th>íƒ„ì†Œë‹¨ê°€ (â‚©/tCOâ‚‚e)</th>
              <th>ë©”íƒ„ ìŠ¬ë¦½ (%)</th>
              <th>GWP100(CHâ‚„)</th>
              <th>ë¦¬ìŠ¤íŠ¸</th>
              <th>ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody id="baselineBody"></tbody>
        </table>
      </div>
      <div class="kpi mt12">
        <div class="chip"><strong>ê¸°ì¤€(í•©ê³„) ì—°ë£Œë¹„</strong><span id="kpiBaseFuel">-</span></div>
        <div class="chip"><strong>ê¸°ì¤€(í•©ê³„) íƒ„ì†Œë¹„ìš©</strong><span id="kpiBaseCarbon">-</span></div>
        <div class="chip"><strong>ê¸°ì¤€(í•©ê³„) ì´ë¹„ìš©</strong><span id="kpiBaseTotal">-</span></div>
      </div>
      <div class="small mt8" style="color:#b9c8e8;">
        <strong>ê¸°ì¤€(í•©ê³„) íƒ„ì†Œë¹„ìš© ì‚°ì¶œ ê³µì‹:</strong><br>
        ëª¨ë“  ê¸°ì¤€ì—°ë£Œ í–‰ì— ëŒ€í•´<br>
        <span style="font-family:monospace;">(ì—°ê°„ ì‚¬ìš©ëŸ‰ Ã— ë°°ì¶œê³„ìˆ˜ + ì—°ê°„ ì‚¬ìš©ëŸ‰ Ã— (ë©”íƒ„ìŠ¬ë¦½%/100) Ã— GWP) Ã— íƒ„ì†Œë‹¨ê°€</span>ë¥¼ í•©ì‚°<br>
        <span style="font-family:monospace;">= Î£ [ (vol Ã— ef + vol Ã— (slip/100) Ã— gwp) Ã— cprice ]</span><br>
        <span style="font-size:11px;">vol: ì—°ê°„ ì‚¬ìš©ëŸ‰(í†¤), ef: ë°°ì¶œê³„ìˆ˜(tCOâ‚‚/í†¤), slip: ë©”íƒ„ìŠ¬ë¦½(%), gwp: GWP100(CHâ‚„), cprice:
          íƒ„ì†Œë‹¨ê°€(â‚©/tCOâ‚‚e)</span>
      </div>
    </section>



    <section class="card">
      <h2>ëŒ€ì•ˆ ì—°ë£Œ <span class="pill">LNGÂ·BioÂ·HydrogenÂ·Methanol</span></h2>
      <div class="small preset">ê¸°ë³¸ê°’: <strong>VLSFO (ì €ìœ í™©ìœ )</strong> EF 3.114, Slip 0%, GWP 27.2 Â· <strong>MGO
          (ê²½ìœ )</strong> EF 3.206, Slip 0%, GWP 27.2 Â· <strong>LNG (ì•¡í™”ì²œì—°ê°€ìŠ¤)</strong> EF 2.75, Slip 0.2%, GWP 27.2 Â·
        <strong>Bio (ë°”ì´ì˜¤ì—°ë£Œ)</strong> EF 0.5, Slip 0%, GWP 27.2 Â· <strong>Hydrogen (ìˆ˜ì†Œ)</strong> EF 0, Slip 0%, GWP 27.2
        Â· <strong>Methanol (ë©”íƒ„ì˜¬)</strong> EF 1.375, Slip 0%, GWP 27.2</div>
      <div class="row-actions mt8">
        <button class="btn" onclick="addFuel('LNG')">+ LNG (ì•¡í™”ì²œì—°ê°€ìŠ¤)</button>
        <button class="btn" onclick="addFuel('Bio')">+ Bio (ë°”ì´ì˜¤ì—°ë£Œ)</button>
        <button class="btn" onclick="addFuel('Hydrogen')">+ Hydrogen (ìˆ˜ì†Œ)</button>
        <button class="btn" onclick="addFuel('Methanol')">+ Methanol (ë©”íƒ„ì˜¬)</button>
        <button class="btn ghost" onclick="addFuel('Custom')">+ ì‚¬ìš©ì ì§€ì •</button>
      </div>
      <div class="scroll mt8">
        <table id="tblFuel">
          <thead>
            <tr>
              <th>ìœ ì¢… <span class="small">(ê¸°ë³¸ê°’ ìë™ ì ìš©)</span></th>
              <th>ì—°ê°„ ì‚¬ìš©ëŸ‰ (í†¤)</th>
              <th>ëª¨ë“œ</th>
              <th>ë‹¨ê°€(â‚©/í†¤) ë˜ëŠ” ì—°ê°„ë¹„ìš© í‰ê· (â‚©)</th>
              <th>ë°°ì¶œê³„ìˆ˜ (tCOâ‚‚/í†¤)</th>
              <th>íƒ„ì†Œë‹¨ê°€ (â‚©/tCOâ‚‚e)</th>
              <th>ë©”íƒ„ ìŠ¬ë¦½ (%)</th>
              <th>GWP100(CHâ‚„)</th>
              <th>ë¦¬ìŠ¤íŠ¸</th>
              <th>ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>ê²°ê³¼ í‘œ</h2>
      <div class="scroll mt8">
        <table id="tblResult">
          <thead>
            <tr>
              <th>ìœ ì¢…</th>
              <th>ì—°ë£Œë¹„</th>
              <th>íƒ„ì†Œë¹„ìš©</th>
              <th><strong>ì´ë¹„ìš©</strong></th>
              <th>ì—°ë£Œ í”„ë¦¬ë¯¸ì—„</th>
              <th>íƒ„ì†Œ ì ˆê°(+) / ì¦ê°€(-)</th>
              <th><strong>ìˆœíš¨ê³¼</strong></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>ì°¨íŠ¸</h2>
      <div class="card" style="background:#0e1627" style="background:#0e1627; min-height:320px; padding:16px">
        <h3 style="margin:0 0 8px">ì´ë¹„ìš© êµ¬ì„± (ê¸°ì¤€ ê° í–‰ + í•©ê³„ + ëŒ€ì•ˆ)</h3><canvas id="barStack" height="150"></canvas>
      </div>
      <div class="card mt12" style="background:#0e1627" style="background:#0e1627; min-height:260px; padding:16px">
        <h3 style="margin:0 0 8px">(ê¸°ì¤€ í•©ê³„ ëŒ€ë¹„) ì—°ë£Œ í”„ë¦¬ë¯¸ì—„Â·íƒ„ì†Œ ì ˆê°Â·ìˆœíš¨ê³¼</h3><canvas id="barDelta" height="120"></canvas>
      </div>
    </section>

    <section id="testPanel" class="card">
      <h2>ì§„ë‹¨ / í…ŒìŠ¤íŠ¸</h2>
      <div class="small">í•µì‹¬ ê³„ì‚° ë¡œì§ê³¼ "ê¸°ì¤€ í•©ê³„" ë°˜ì˜ ë™ì‘ì„ ì ê²€í•©ë‹ˆë‹¤.</div>
      <div class="row-actions mt8">
        <button class="btn" id="runTestsBtn" onclick="runTests()">Run Tests</button>
      </div>
      <pre id="testOut"></pre>
    </section>
  </div>

  <script>
    // ---------- Presets ----------
    const PRESET_ALIASES = { 'H2': 'HYDROGEN', 'MEOH': 'METHANOL', 'BIO': 'BIO', 'LNG': 'LNG', 'VLSFO': 'VLSFO', 'MGO': 'MGO' };
    const PRESETS = {
      VLSFO: { ef: 3.114, slip: 0, gwp: 27.2, defaultVol: 10000, defaultPrice: 1200000 },
      MGO: { ef: 3.206, slip: 0, gwp: 27.2, defaultVol: 10000, defaultPrice: 1250000 },
      LNG: { ef: 2.75, slip: 0.2, gwp: 27.2, defaultVol: 10000, defaultPrice: 1000000 },
      BIO: { ef: 0.5, slip: 0, gwp: 27.2, defaultVol: 10000, defaultPrice: 1400000 },
      HYDROGEN: { ef: 0, slip: 0, gwp: 27.2, defaultVol: 10000, defaultPrice: 6000000 },
      METHANOL: { ef: 1.375, slip: 0, gwp: 27.2, defaultVol: 10000, defaultPrice: 2500000 }
    };


    // ---------- Energy content (MMBtu/mt) for efficiency mode ----------
    const ENERGY = {
      VLSFO: 40.2,
      MGO: 40.5,
      LNG: 52.0,
      BIO: 35.8,
      HYDROGEN: 120.0,
      METHANOL: 19.9
    };

    function renderEnergyTable() {
      const body = document.getElementById('energyBody');
      body.innerHTML = '';
      Object.keys(ENERGY).forEach(key => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${key}</td><td><input type="number" step="0.01" value="${ENERGY[key]}" data-key="${key}" style="width:100px"/></td>`;
        body.appendChild(tr);
      });
      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      body.querySelectorAll('input[type=number]').forEach(inp => {
        inp.addEventListener('input', e => {
          const k = e.target.dataset.key;
          const v = parseFloat(e.target.value);
          if (k && isFinite(v)) {
            ENERGY[k] = v;
            recomputeAllEffRows();
          }
        });
      });
    }
    function getEnergyPerMt(key) {
      const k = (key || '').toString().toUpperCase().trim();
      if (ENERGY[k] !== undefined) return ENERGY[k];
      // fuzzy contains match
      for (const kk of Object.keys(ENERGY)) { if (k.includes(kk)) return ENERGY[kk]; }
      return 0;
    }

    // ---------- Market reference snapshot (editable) ----------
    // USD/mt values taken from public sources as of 2025-10-02 (see chat for citations)
    const MARKET = [
      { key: 'VLSFO', name: 'VLSFO (ì €ìœ í™©ìœ )', usd: 516.5, src: 'Ship & Bunker â€” Global 20 Avg' },
      { key: 'MGO', name: 'MGO (ê²½ìœ )', usd: 767.5, src: 'Ship & Bunker â€” Global 20 Avg' },
      { key: 'BIO', name: 'Bio (ë°”ì´ì˜¤ì—°ë£Œ)', usd: 717.5, src: 'Ship & Bunker â€” Singapore B24 (2025-09-29)' },
      { key: 'LNG', name: 'LNG (ì•¡í™”ì²œì—°ê°€ìŠ¤)', usd: +(11.05 * 52).toFixed(1), note: 'JKM 11.05 $/MMBtu Ã— 52 MMBtu/mt', src: 'JKM futures (converted)' },
      { key: 'METHANOL', name: 'Methanol (ë©”íƒ„ì˜¬)', usd: 360, src: 'Methanex APCP (Asia)' },
      { key: 'HYDROGEN', name: 'Hydrogen (ìˆ˜ì†Œ)', usd: 4000, src: 'EEX HYDRIX (weekly, region-specific)' }
    ];

    // ---------- Utilities ----------
    function fmt(n) { return (n === null || n === undefined || n === '') ? '-' : (isFinite(n) ? (+n).toLocaleString('ko-KR') : n); }
    function num(v) { const n = +v; return isFinite(n) ? n : 0; }
    let barStack = null, barDelta = null;
    let ROWSEQ = 1;

    // ---- Visibility helpers for annual-volume mode ----
    function _setVolCellVisibility(tr, isBaseline) {
      const tdVol = tr.children[1];
      const modeSel = isBaseline ? '.b-mode' : '.mode';
      const mode = tr.querySelector(modeSel).value;
      const inputVol = tdVol.querySelector('input');
      if (!inputVol) return;
      if (mode === 'annual') {
        if (tdVol.dataset.show === '1') { inputVol.classList.remove('hidden'); }
        else { inputVol.classList.add('hidden'); }
      } else {
        inputVol.classList.remove('hidden');
      }
    }

    function populateEffRefOptions(sel) {
      const opts = ['<option value="">ê¸°ì¤€ ì„ íƒ</option>', '<option value="__SUM__">ê¸°ì¤€ í•©ê³„(ëª¨ë“  ê¸°ì¤€)</option>'];
      const bases = collectBaselines();
      bases.forEach((b, i) => { opts.push(`<option value="${b.id}">${b.name || ('ê¸°ì¤€' + (i + 1))}</option>`); });
      sel.innerHTML = opts.join('');
    }
    function toggleEffControls(tr) {
      const mode = tr.querySelector('.mode').value;
      const refSel = tr.querySelector('.eff-ref');
      const hintEl = tr.querySelector('.eff-hint');
      const volInput = tr.children[1].querySelector('input');
      if (mode === 'eff') {
        refSel.style.display = ''; hintEl.style.display = ''; volInput.readOnly = true;
        if (!refSel.options.length) populateEffRefOptions(refSel);
      } else {
        refSel.style.display = 'none'; hintEl.style.display = 'none'; volInput.readOnly = false;
      }
    }
    function effectiveBaselineVolume(b) { // tons
      if (!b) return 0;
      let v = +b.vol;
      if (!isFinite(v) || v <= 0) {
        if (b.mode === 'annual') {
          const price = getMarketKrwPerMtByKey((b.name || '').toUpperCase());
          const annual = annualTotalFromRow(b.tr, true);
          if (price && annual) { v = annual / price; }
        }
      }
      return (isFinite(v) && v > 0) ? v : 0;
    }
    function computeEffRow(tr) {
      try {
        const nameVal = (tr.querySelector('.fname').value || '').trim();
        const modeVal = tr.querySelector('.mode').value;
        if (modeVal !== 'eff') return;
        const refSel = tr.querySelector('.eff-ref');
        const hintEl = tr.querySelector('.eff-hint');
        const volInput = tr.children[1].querySelector('input');
        const priceInp = tr.children[3].querySelector('.priceOrAnnual');

        // ê¸°ì¤€ì—°ë£Œ ë¯¸ì„ íƒ ì‹œ ìë™ê³„ì‚° ë°©ì§€ ë° 0ìœ¼ë¡œ ì´ˆê¸°í™”
        if (!refSel || !refSel.value || refSel.value === "") {
          if (volInput) volInput.value = 0;
          if (priceInp) priceInp.value = 0;
          if (hintEl) hintEl.textContent = 'ê¸°ì¤€ì—°ë£Œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.';
          return;
        }

        // 1) unit price from MARKET
        const mKrw = getMarketKrwPerMtByKey(nameVal.toUpperCase());
        if (mKrw && priceInp) { priceInp.value = Math.round(mKrw); }

        // 2) energy-based volume
        const eAlt = getEnergyPerMt(nameVal);
        if (!(eAlt > 0)) { if (hintEl) hintEl.textContent = 'ëŒ€ì•ˆ ì—ë„ˆì§€í•¨ëŸ‰ ì—†ìŒ (ENERGY ì„¤ì •)'; return; }

        const bases = collectBaselines();
        if (!bases.length) { if (hintEl) hintEl.textContent = 'ê¸°ì¤€ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }

        let totalBaseEnergy = 0;
        if (refSel && refSel.value === '__SUM__') {
          bases.forEach(b => { totalBaseEnergy += effectiveBaselineVolume(b) * getEnergyPerMt(b.name); });
        } else {
          const ref = bases.find(b => b.id === (refSel && refSel.value)) || bases[0];
          totalBaseEnergy = effectiveBaselineVolume(ref) * getEnergyPerMt(ref.name);
        }
        if (!(totalBaseEnergy > 0)) { if (hintEl) hintEl.textContent = 'ê¸°ì¤€ ì—ë„ˆì§€/ì‹œì„¸/ì—°ê°„ë¹„ìš© í™•ì¸'; return; }

        const volAlt = totalBaseEnergy / eAlt;
        if (isFinite(volAlt) && volInput) {
          volInput.value = (Math.round(volAlt * 100) / 100).toFixed(2);
          const tdVol = tr.children[1]; tdVol.dataset.show = '1'; _setVolCellVisibility(tr, false);
        }
        if (hintEl) {
          const label = (refSel && refSel.value === '__SUM__') ? 'í•©ê³„' : (bases.find(b => b.id === (refSel && refSel.value))?.name || bases[0].name);
          const unitTxt = priceInp && priceInp.value ? Number(priceInp.value).toLocaleString('ko-KR') : '-';
          hintEl.textContent = `ê¸°ì¤€: ${label} â†’ í™˜ì‚° ${volInput.value} í†¤ Â· ë‹¨ê°€ ${unitTxt} â‚©/í†¤`;
        }
      } catch (e) { }
    }
    function recomputeAllEffRows() {
      [...fuelBody.querySelectorAll('tr')].forEach(tr => computeEffRow(tr));
      recalc();
    }


    function refreshAllVolVisibility() {
      [...baselineBody.querySelectorAll('tr.baseline')].forEach(tr => _setVolCellVisibility(tr, true));
      [...fuelBody.querySelectorAll('tr')].forEach(tr => _setVolCellVisibility(tr, false));
    }


    const baselineBody = document.getElementById('baselineBody');
    const fuelBody = document.querySelector('#tblFuel tbody');
    const resultBody = document.querySelector('#tblResult tbody');
    const marketBody = document.getElementById('marketBody');

    // ----- Market table rendering -----
    function renderMarket() {

      const fx = num(document.getElementById('fxUSDKRW').value || 0);
      marketBody.innerHTML = '';
      MARKET.forEach((m, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="m-name" value="${m.name || ''}" placeholder="ìœ ì¢…ëª…"/></td>
          <td><input class="m-usd" type="number" step="0.1" value="${m.usd}"/></td>
          <td class="right m-krw">${m.usd ? (m.usd * fx).toLocaleString('ko-KR') : '-'}</td>
          <td><input class="m-src" value="${m.note ? (m.src + ' â€” ' + m.note) : (m.src || '')}" placeholder="ì¶œì²˜"/></td>
          <td class="row-actions">
            <button class="btn ghost m-del" type="button">ì‚­ì œ</button>
          </td>`;
        marketBody.appendChild(tr);
      });
      // bind inputs
      marketBody.querySelectorAll('tr').forEach((row, i) => {
        const nameInp = row.querySelector('.m-name');
        const usdInp = row.querySelector('.m-usd');
        const srcInp = row.querySelector('.m-src');
        const krwCell = row.querySelector('.m-krw');
        const delBtn = row.querySelector('.m-del');

        nameInp.addEventListener('input', () => {
          MARKET[i].name = nameInp.value;
          MARKET[i].key = normalizeKey(nameInp.value);
        });
        usdInp.addEventListener('input', () => {
          MARKET[i].usd = num(usdInp.value);
          krwCell.textContent = MARKET[i].usd ? (MARKET[i].usd * num(document.getElementById('fxUSDKRW').value)).toLocaleString('ko-KR') : '-';
        });
        srcInp.addEventListener('input', () => {
          MARKET[i].src = srcInp.value;
        });
        delBtn.addEventListener('click', () => {
          MARKET.splice(i, 1);
          renderMarket();
        });
      });
    }

    document.getElementById('fxUSDKRW').addEventListener('input', () => { renderMarket(); recomputeAllEffRows(); });
    const btnMarketAdd = document.getElementById('btnMarketAdd');
    if (btnMarketAdd) { btnMarketAdd.addEventListener('click', () => { MARKET.push({ key: 'CUSTOM', name: 'Custom', usd: '', src: '' }); renderMarket(); }); }

    // ----- Annual volume auto-calc from Market -----
    function getMarketKrwPerMtByKey(key) {
      const fx = num(document.getElementById('fxUSDKRW').value || 0);
      const idx = MARKET.findIndex(m => m.key === key);
      if (idx < 0) return null;
      const usdInput = marketBody.querySelectorAll('input.m-usd')[idx];
      const usd = usdInput ? num(usdInput.value) : num(MARKET[idx].usd);
      if (!usd || !fx) return null;
      return usd * fx; // KRW/mt
    }

    function annualTotalFromRow(tr, isBaseline) {
      // samples sum if present, else priceOrAnnual
      const samples = getSamples(tr);
      if (samples.length) { return samples.reduce((a, b) => a + b, 0); }
      const sel = isBaseline ? '.b-priceOrAnnual' : '.priceOrAnnual';
      return num(tr.querySelector(sel).value);
    }

    function computeVolumesFromMarket(scope) {
      let updated = 0, skipped = 0;
      const applyRow = (tr, isBaseline) => {
        const nameSel = isBaseline ? '.b-fname' : '.fname';
        const modeSel = isBaseline ? '.b-mode' : '.mode';
        const volSel = isBaseline ? '.b-vol' : 'td:nth-child(2) input';
        const fuelName = (tr.querySelector(nameSel).value || '').trim();
        const mode = tr.querySelector(modeSel).value;
        if (mode !== 'annual') { skipped++; return; }
        const key = normalizeKey(fuelName);
        const krwPerMt = getMarketKrwPerMtByKey(key);
        if (!krwPerMt) { skipped++; return; }
        const annual = annualTotalFromRow(tr, isBaseline);
        if (!annual) { skipped++; return; }
        const vol = annual / krwPerMt;
        const volInput = isBaseline ? tr.querySelector(volSel) : tr.querySelector(volSel);
        if (volInput) { volInput.value = (Math.round(vol * 100) / 100).toFixed(2); updated++; }
      };

      if (scope === 'baseline' || scope === 'both') {
        [...baselineBody.querySelectorAll('tr.baseline')].forEach(tr => applyRow(tr, true));
      }
      if (scope === 'alt' || scope === 'both') {
        [...fuelBody.querySelectorAll('tr')].forEach(tr => applyRow(tr, false));
      }
      recalc(); refreshAllVolVisibility && refreshAllVolVisibility();
      // reveal all annual volume inputs after computation
      [...baselineBody.querySelectorAll('tr.baseline')].forEach(tr => {
        if (tr.querySelector('.b-mode').value === 'annual') {
          tr.children[1].dataset.show = '1';
          _setVolCellVisibility(tr, true);
        }
      });
      [...fuelBody.querySelectorAll('tr')].forEach(tr => {
        if (tr.querySelector('.mode').value === 'annual') {
          tr.children[1].dataset.show = '1';
          _setVolCellVisibility(tr, false);
        }
      });
      const msg = `ì‚¬ìš©ëŸ‰ ì‚°ì¶œ ì™„ë£Œ â€” ì—…ë°ì´íŠ¸: ${updated}ê°œ, ê±´ë„ˆëœ€: ${skipped}ê°œ`;
      console.log(msg);
      // ê°„ë‹¨ ì•Œë¦¼
      if (typeof window?.alert === 'function') {
        // ë„ˆë¬´ ì¦ì€ alert ë°©ì§€: ìµœì†Œ í”¼ë“œë°±ë§Œ
        setTimeout(() => alert(msg), 0);
      }
    }

    // Wire buttons in Market box
    const btnCalcVolBase = document.getElementById('btnCalcVolBase');
    const btnCalcVolAlt = document.getElementById('btnCalcVolAlt');
    const btnCalcVolAll = document.getElementById('btnCalcVolAll');
    if (btnCalcVolBase) btnCalcVolBase.addEventListener('click', () => computeVolumesFromMarket('baseline'));
    if (btnCalcVolAlt) btnCalcVolAlt.addEventListener('click', () => computeVolumesFromMarket('alt'));
    if (btnCalcVolAll) btnCalcVolAll.addEventListener('click', () => computeVolumesFromMarket('both'));

    // ----- Button bindings (baseline add & import/export) -----
    const btnV = document.getElementById('btnAddBaseVLSFO');
    const btnM = document.getElementById('btnAddBaseMGO');
    const btnC = document.getElementById('btnAddBaseCustom');
    if (btnV) btnV.addEventListener('click', () => addBaseline('VLSFO'));
    if (btnM) btnM.addEventListener('click', () => addBaseline('MGO'));
    if (btnC) btnC.addEventListener('click', () => addBaseline('Custom'));

    // JSON Export / Import wiring
    const btnExport = document.getElementById('exportJson');
    const inpImport = document.getElementById('importJsonInput');
    if (btnExport) {
      btnExport.addEventListener('click', () => {
        const data = exportData();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'bunkering_config.json'; a.click();
        URL.revokeObjectURL(url);
      });
    }
    if (inpImport) {
      inpImport.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const fr = new FileReader();
        fr.onload = () => {
          try { const data = JSON.parse(fr.result); importData(data); }
          catch (err) { alert('JSON íŒŒì‹± ì˜¤ë¥˜: ' + err.message); }
        };
        fr.readAsText(f);
      });
    }

    function addFromMarket(idx) {
      const m = MARKET[idx];
      addFuel(m.key);
      const last = fuelBody.lastElementChild;
      // mode: unit, set price = KRW/mt
      const fx = num(document.getElementById('fxUSDKRW').value || 0);
      const usdInput = marketBody.querySelectorAll('input.m-usd')[idx];
      const usd = num(usdInput ? usdInput.value : m.usd);
      const krw = Math.round(usd * fx);
      last.children[3].querySelector('.priceOrAnnual').value = krw;
      // apply preset EF/Slip/GWP already handled by addFuel; no-op
      recalc(); refreshAllVolVisibility();
    }

    // ----- Samples UI (baseline & fuel rows) -----
    function toggleSamples(btn) {
      const mainTr = btn.closest('tr');
      let sampleTr = mainTr.nextElementSibling;
      const colSpan = mainTr.children.length;
      if (!sampleTr || !sampleTr.classList.contains('sample-row')) {
        sampleTr = document.createElement('tr');
        sampleTr.className = 'sample-row';
        sampleTr.innerHTML = `<td colspan="${colSpan}">
          <details open>
            <summary>ê°€ê²©/ë¹„ìš© ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</summary>
            <div class="small">ëª¨ë“œê°€ <strong>ë‹¨ê°€Ã—ì‚¬ìš©ëŸ‰</strong>ì´ë©´ í•­ëª©ë“¤ì˜ <strong>ì‚°ìˆ í‰ê·  ë‹¨ê°€(â‚©/í†¤)</strong>ë¥¼, <strong>ì—°ê°„ë¹„ìš©(í•©ì‚°)</strong>ì´ë©´ <strong>í•©ê³„(â‚©)</strong>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
            <div class="row-actions mt8"><button class="btn" type="button" onclick="addSampleRow(this)">+ í•­ëª© ì¶”ê°€</button></div>
            <div class="scroll mt8"><table class="innerTable"><thead><tr><th>#</th><th>ê¸ˆì•¡</th><th>ì‚­ì œ</th></tr></thead><tbody></tbody></table></div>
          </details>
        </td>`;
        mainTr.parentNode.insertBefore(sampleTr, mainTr.nextSibling);
      } else {
        sampleTr.style.display = (sampleTr.style.display === 'none') ? '' : 'none';
      }
      recalc(); refreshAllVolVisibility();
    }

    function addSampleRow(el) {
      const wrap = el.closest('td');
      const tbody = wrap.querySelector('tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = '<td class="right"></td><td><input type="number" value="0" step="1000" min="0"/></td><td><button class="btn" type="button" onclick="this.closest(\'tr\').remove(); recalc();">ì‚­ì œ</button></td>';
      tbody.appendChild(tr);
      [...tbody.querySelectorAll('tr')].forEach((row, i) => row.children[0].textContent = i + 1);
      tbody.querySelectorAll('input').forEach(inp => inp.addEventListener('input', recalc));
    }

    function getSamples(tr) {
      const row = tr.nextElementSibling;
      if (!row || !row.classList || !row.classList.contains('sample-row')) return [];
      return [...row.querySelectorAll('tbody input')].map(i => num(i.value)).filter(v => v > 0);
    }

    // ----- Baseline rows -----
    function addBaseline(kind) {
      const tr = document.createElement('tr');
      tr.className = 'baseline';
      const upper = normalizeKey(kind);
      const preset = PRESETS[upper] || { ef: 0, slip: 0, gwp: 27.2, defaultVol: 0, defaultPrice: 0 };
      const d = { name: kind || '', vol: preset.defaultVol, price: preset.defaultPrice, ef: preset.ef, cprice: 0, slip: preset.slip, gwp: preset.gwp };
      tr.innerHTML = `
        <td>
          <div style="display:flex; flex-direction:column; gap:4px">
            <input class="b-fname" value="${d.name}" placeholder="ì—°ë£Œëª…" />
            <span class="preset">ê¸°ë³¸ê°’ EF ${d.ef}, Slip ${d.slip}%, GWP ${d.gwp}</span>
          </div>
        </td>
        <td><input class="b-vol" type="number" value="${d.vol}" step="100" min="0"/></td>
        <td><select class="b-mode"><option value="unit">ë‹¨ê°€Ã—ì‚¬ìš©ëŸ‰</option><option value="annual" selected>ì—°ê°„ë¹„ìš©(í•©ì‚°)</option></select></td>
        <td><input class="b-priceOrAnnual" type="number" value="${d.price}" step="1000" min="0"/></td>
        <td><input class="b-ef" type="number" value="${d.ef}" step="0.01" min="0"/></td>
        <td><input class="b-cprice" type="number" value="0" step="100" min="0"/></td>
        <td><input class="b-slip" type="number" value="${d.slip}" step="0.01" min="0"/></td>
        <td><input class="b-gwp" type="number" value="${d.gwp}" step="0.1" min="0"/></td>
        <td class="row-actions"><button class="btn ghost" type="button" onclick="toggleSamples(this)">ë¦¬ìŠ¤íŠ¸</button></td>
        <td class="row-actions"><button class="btn" type="button" onclick="removeBaselineRow(this)">ì‚­ì œ</button></td>`;
      // ê³ ìœ  id ë¶€ì—¬
      tr.dataset.rowid = 'base_' + Math.random().toString(36).substr(2, 9);
      baselineBody.appendChild(tr);
      tr.querySelectorAll('input,select').forEach(i => i.addEventListener('input', () => {
        populateEffRefOptions && document.querySelectorAll('#tblFuel .eff-ref').forEach(s => populateEffRefOptions(s));
        recomputeAllEffRows();
        recalc();
      }));
      const modeSel = tr.querySelector('.b-mode');
      modeSel.addEventListener('change', () => {
        const tdVol = tr.children[1];
        delete tdVol.dataset.show; // reset reveal flag for annual
        _setVolCellVisibility(tr, true);
        recalc();
      });
      _setVolCellVisibility(tr, true);

      tr.querySelector('.b-fname').addEventListener('change', (e) => {
        if (applyPresetToRow(tr, e.target.value)) recalc();
        recomputeAllEffRows();
        recalc();
      });
      recalc(); refreshAllVolVisibility();
    }

    function removeBaselineRow(btn) {
      const tr = btn.closest('tr');
      const all = document.querySelectorAll('#tblBase tbody tr.baseline');
      if (all.length <= 1) { alert('ìµœì†Œ 1ê°œì˜ ê¸°ì¤€ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.'); return; }
      const next = tr.nextElementSibling;
      if (next && next.classList && next.classList.contains('sample-row')) next.remove();
      tr.remove();
      recalc(); refreshAllVolVisibility();
    }

    function readBaseline(tr) {
      return {
        tr,
        id: tr.dataset.rowid,
        name: tr.querySelector('.b-fname').value.trim() || 'ê¸°ì¤€',
        vol: num(tr.querySelector('.b-vol').value),
        mode: tr.querySelector('.b-mode').value,
        priceOrAnnual: num(tr.querySelector('.b-priceOrAnnual').value),
        ef: num(tr.querySelector('.b-ef').value),
        cprice: num(tr.querySelector('.b-cprice').value),
        slip: num(tr.querySelector('.b-slip').value),
        gwp: num(tr.querySelector('.b-gwp').value),
        samples: getSamples(tr)
      };
    }

    // ----- Alternative fuels -----
    function normalizeKey(name) {
      const key = (name || '').trim().toUpperCase();
      return PRESETS[key] ? key : (PRESET_ALIASES[key] || key);
    }

    function applyPresetToRow(tr, fuelName) {
      const key = normalizeKey(fuelName);
      const p = PRESETS[key];
      if (!p) return false;
      if (tr.classList.contains('baseline')) {
        tr.querySelector('.b-ef').value = p.ef;
        tr.querySelector('.b-slip').value = p.slip;
        tr.querySelector('.b-gwp').value = p.gwp;
      } else {
        tr.querySelector('.ef').value = p.ef;
        tr.querySelector('.slip').value = p.slip;
        tr.querySelector('.gwp').value = p.gwp;
      }
      return true;
    }

    function addFuel(kind) {
      const tr = document.createElement('tr');
      const upper = normalizeKey(kind);
      const preset = PRESETS[upper];
      // í”„ë¦¬ì…‹ì´ ì•„ë‹Œ ê²½ìš° ì—°ê°„ì‚¬ìš©ëŸ‰ê³¼ ë‹¨ê°€ 0ìœ¼ë¡œ ì´ˆê¸°í™”
      const d = {
        name: kind || '',
        vol: preset ? preset.defaultVol : 0,
        price: preset ? preset.defaultPrice : 0,
        ef: preset ? preset.ef : 0,
        cprice: 0,
        slip: preset ? preset.slip : 0,
        gwp: preset ? preset.gwp : 27.2
      };
      tr.innerHTML = `
        <td>
          <div style="display:flex; flex-direction:column; gap:4px">
            <input class="fname" value="${d.name}" placeholder="ì—°ë£Œëª…" />
            <span class="preset">ê¸°ë³¸ê°’ EF ${d.ef}, Slip ${d.slip}%, GWP ${d.gwp}</span>
          </div>
        </td>
        <td><input type="number" value="${d.vol}" step="100" min="0"/></td>
        <td><div style="display:flex; gap:6px; align-items:center"><select class="mode"><option value="unit">ë‹¨ê°€Ã—ì‚¬ìš©ëŸ‰</option><option value="annual" selected>ì—°ê°„ë¹„ìš©(í•©ì‚°)</option><option value="eff">ê¸°ì¤€ì—°ë£Œ ëŒ€ë¹„(íš¨ìœ¨)</option></select><select class="eff-ref" style="display:none"></select></div><div class="small eff-hint" style="display:none"></div></td>
        <td><input class="priceOrAnnual" type="number" value="${d.price}" step="1000" min="0"/></td>
        <td><input class="ef" type="number" value="${d.ef}" step="0.01" min="0"/></td>
        <td><input class="cprice" type="number" value="0" step="100" min="0"/></td>
        <td><input class="slip" type="number" value="${d.slip}" step="0.01" min="0"/></td>
        <td><input class="gwp" type="number" value="${d.gwp}" step="0.1" min="0"/></td>
        <td class="row-actions"><button class="btn ghost" type="button" onclick="toggleSamples(this)">ë¦¬ìŠ¤íŠ¸</button></td>
        <td class="row-actions"><button class="btn" onclick="this.closest('tr').remove(); recalc();">ì‚­ì œ</button></td>`;

      fuelBody.appendChild(tr);
      tr.querySelectorAll('input,select').forEach(i => i.addEventListener('input', recalc));
      const modeSel = tr.querySelector('.mode');
      // ëª¨ë“œ ë³€ê²½ ì‹œ
      modeSel.addEventListener('change', () => {
        _setVolCellVisibility(tr, false);
        toggleEffControls(tr);
        if (tr.querySelector('.mode').value === 'eff') {
          const volInput = tr.children[1].querySelector('input');
          if (volInput) { volInput.value = ''; }
          const priceInp = tr.children[3].querySelector('.priceOrAnnual');
          if (priceInp) { priceInp.value = ''; }
          const sel = tr.querySelector('.eff-ref');
          if (sel) { sel.focus(); }
        }
        computeEffRow(tr);
        recalc();
      });
      _setVolCellVisibility(tr, false);
      toggleEffControls(tr);
      const effSel = tr.querySelector('.eff-ref');
      effSel.addEventListener('change', () => {
        recomputeAllEffRows(); // ëª¨ë“  ëŒ€ì•ˆì—°ë£Œ íš¨ìœ¨ëª¨ë“œ í–‰ ì¬ê³„ì‚°
        recalc();
      });

      // ì—°ë£Œëª… ë³€ê²½ ì‹œ
      const fnameInput = tr.querySelector('.fname');
      fnameInput.addEventListener('change', (e) => {
        if (applyPresetToRow(tr, e.target.value)) recalc();
        recomputeAllEffRows();
        recalc();
      });
      // ì—°ë£Œëª… ì…ë ¥ ì‹¤ì‹œê°„ ë°˜ì˜ (input ì´ë²¤íŠ¸)
      fnameInput.addEventListener('input', () => {
        computeEffRow(tr);
        recalc();
      });
      recalc(); refreshAllVolVisibility();
    }

    function collectFuels() {
      const rows = [...fuelBody.querySelectorAll('tr')];
      return rows.map(tr => ({
        tr,
        name: tr.querySelector('.fname').value.trim() || 'ì—°ë£Œ',
        vol: num(tr.children[1].querySelector('input').value),
        mode: tr.children[2].querySelector('select').value,
        priceOrAnnual: num(tr.children[3].querySelector('.priceOrAnnual').value),
        ef: num(tr.children[4].querySelector('input').value),
        cprice: num(tr.children[5].querySelector('input').value),
        slip: num(tr.children[6].querySelector('input').value),
        gwp: num(tr.children[7].querySelector('input').value),
        samples: getSamples(tr),
      }));
    }

    function avg(arr) { if (!arr.length) return 0; return arr.reduce((a, b) => a + b, 0) / arr.length; }

    function calcCost(vol, mode, priceOrAnnual, samples, ef, cprice, slipPct, gwp) {
      let fuelCost = 0; let hint = null;
      if (mode === 'annual') {
        const sum = samples.length ? samples.reduce((a, b) => a + b, 0) : priceOrAnnual; // í•©ì‚°
        const mean = samples.length ? (sum / samples.length) : priceOrAnnual; // í‘œì‹œìš© í‰ê· 
        fuelCost = sum; hint = mean;
      } else {
        const mean = (samples.length ? avg(samples) : priceOrAnnual);
        fuelCost = vol * mean; hint = mean;
      }
      const co2e = (vol * ef) + (vol * (slipPct / 100) * gwp);
      const carbon = co2e * cprice;
      return { fuelCost, carbon, hint };
    }

    function collectBaselines() {
      return [...baselineBody.querySelectorAll('tr.baseline')].map(readBaseline);
    }

    function recalc() {
      // Baseline (sum over rows)
      const baselines = collectBaselines();
      if (baselines.length === 0) { addBaseline('VLSFO'); return; }
      const baseRowsCalcs = baselines.map(b => ({ name: b.name, ...calcCost(b.vol, b.mode, b.priceOrAnnual, b.samples, b.ef, b.cprice, b.slip, b.gwp) }));
      const baseFuelSum = baseRowsCalcs.reduce((s, x) => s + x.fuelCost, 0);
      const baseCarbonSum = baseRowsCalcs.reduce((s, x) => s + x.carbon, 0);

      document.getElementById('kpiBaseFuel').textContent = 'â‚© ' + fmt(baseFuelSum);
      document.getElementById('kpiBaseCarbon').textContent = 'â‚© ' + fmt(baseCarbonSum);
      document.getElementById('kpiBaseTotal').textContent = 'â‚© ' + fmt(baseFuelSum + baseCarbonSum);

      // Alternatives (vs baseline SUM)
      const fuels = collectFuels();
      const rows = fuels.map(f => {
        const r = calcCost(f.vol, f.mode, f.priceOrAnnual, f.samples, f.ef, f.cprice, f.slip, f.gwp);
        if (isFinite(r.hint)) f.tr.querySelector('.priceOrAnnual').value = Math.round(r.hint);
        const total = r.fuelCost + r.carbon;
        const fuelPremium = r.fuelCost - baseFuelSum;
        const carbonSaving = baseCarbonSum - r.carbon; // +ë©´ ì ˆê°
        const net = fuelPremium - carbonSaving; // (+) ë¹„ìš©ì¦ê°€, (âˆ’) ìˆœì ˆê°
        return { name: f.name, fuelCost: r.fuelCost, carbon: r.carbon, total, fuelPremium, carbonSaving, net };
      });

      // Render table (alternatives only â€” ê¸°ì¤€ í•©ê³„ ëŒ€ë¹„)
      resultBody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.name}</td>
          <td class="right">${fmt(r.fuelCost)}</td>
          <td class="right">${fmt(r.carbon)}</td>
          <td class="right"><strong>${fmt(r.total)}</strong></td>
          <td class="right">${fmt(r.fuelPremium)}</td>
          <td class="right" style="color:${r.carbonSaving >= 0 ? '#77ffa1' : '#ffb3b3'}">${fmt(r.carbonSaving)}</td>
          <td class="right" style="color:${r.net <= 0 ? '#77ffa1' : '#ff8a8a'}"><strong>${fmt(r.net)}</strong></td>`;
        resultBody.appendChild(tr);
      });

      // Charts â€” Baseline rows + Baseline SUM + Alternatives
      updateCharts(baseRowsCalcs, { fuel: baseFuelSum, carbon: baseCarbonSum }, rows);
    }

    function updateCharts(baseRows, baseSum, altRows) {
      const labels = baseRows.map(b => `ê¸°ì¤€(${b.name})`).concat(['ê¸°ì¤€(í•©ê³„)']).concat(altRows.map(r => r.name));
      const fuels = baseRows.map(b => b.fuelCost).concat([baseSum.fuel]).concat(altRows.map(r => r.fuelCost));
      const carbons = baseRows.map(b => b.carbon).concat([baseSum.carbon]).concat(altRows.map(r => r.carbon));

      // Delta vs baseline SUM
      const deltaLabels = baseRows.map(b => `ê¸°ì¤€(${b.name})`).concat(altRows.map(r => r.name));
      const fuelPremium = baseRows.map(b => b.fuelCost - baseSum.fuel).concat(altRows.map(r => r.fuelPremium));
      const carbonSaving = baseRows.map(b => baseSum.carbon - b.carbon).concat(altRows.map(r => r.carbonSaving));
      const net = fuelPremium.map((_, i) => fuelPremium[i] - carbonSaving[i]);

      const ctxS = document.getElementById('barStack').getContext('2d');
      const ctxD = document.getElementById('barDelta').getContext('2d');

      if (barStack) barStack.destroy();
      barStack = new Chart(ctxS, {
        type: 'bar',
        data: {
          labels, datasets: [
            { label: 'ì—°ë£Œë¹„', data: fuels, stack: 'S' },
            { label: 'íƒ„ì†Œë¹„ìš©', data: carbons, stack: 'S' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
      });

      if (barDelta) barDelta.destroy();
      barDelta = new Chart(ctxD, {
        type: 'bar',
        data: {
          labels: deltaLabels, datasets: [
            { label: 'ì—°ë£Œ í”„ë¦¬ë¯¸ì—„', data: fuelPremium },
            { label: 'íƒ„ì†Œ ì ˆê°(+)', data: carbonSaving },
            { label: 'ìˆœíš¨ê³¼', type: 'line', data: net, yAxisID: 'y' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: false } } }
      });
    }

    // ----- Export / Import (dynamic baselines) -----
    function exportData() {
      const baselines = collectBaselines().map(b => ({ name: b.name, vol: b.vol, mode: b.mode, priceOrAnnual: b.priceOrAnnual, ef: b.ef, cprice: b.cprice, slip: b.slip, gwp: b.gwp, samples: b.samples }));
      const fuels = collectFuels().map(f => ({ name: f.name, vol: f.vol, mode: f.mode, priceOrAnnual: f.priceOrAnnual, ef: f.ef, cprice: f.cprice, slip: f.slip, gwp: f.gwp, samples: f.samples }));
      return { baselines, fuels };
    }

    function importData(data) {
      // baselines
      baselineBody.innerHTML = '';
      if (Array.isArray(data.baselines) && data.baselines.length) {
        data.baselines.forEach(b => {
          addBaseline(b.name || 'VLSFO');
          const tr = baselineBody.lastElementChild;
          tr.querySelector('.b-fname').value = b.name || 'VLSFO';
          tr.querySelector('.b-vol').value = b.vol ?? PRESETS[(normalizeKey(b.name || 'VLSFO'))]?.defaultVol ?? 10000;
          tr.querySelector('.b-mode').value = b.mode || 'unit';
          tr.querySelector('.b-priceOrAnnual').value = b.priceOrAnnual ?? PRESETS[(normalizeKey(b.name || 'VLSFO'))]?.defaultPrice ?? 1200000;
          tr.querySelector('.b-ef').value = b.ef ?? PRESETS[(normalizeKey(b.name || 'VLSFO'))]?.ef ?? 3.114;
          tr.querySelector('.b-cprice').value = b.cprice ?? 0;
          tr.querySelector('.b-slip').value = b.slip ?? PRESETS[(normalizeKey(b.name || 'VLSFO'))]?.slip ?? 0;
          tr.querySelector('.b-gwp').value = b.gwp ?? 27.2;
          // samples
          toggleSamples(tr.querySelector('button.btn.ghost'));
          const sBody = tr.nextElementSibling.querySelector('tbody'); sBody.innerHTML = '';
          (b.samples || []).forEach(v => { const r = document.createElement('tr'); r.innerHTML = `<td class='right'></td><td><input type='number' value='${v}' step='1000' min='0'/></td><td><button class='btn' type='button' onclick='this.closest("tr").remove(); recalc();'>ì‚­ì œ</button></td>`; sBody.appendChild(r); });
          [...sBody.querySelectorAll('tr')].forEach((row, i) => row.children[0].textContent = i + 1);
          sBody.querySelectorAll('input').forEach(inp => inp.addEventListener('input', recalc));
        });
      } else if (data.baseline) { // legacy single
        addBaseline(data.baseline.name || 'VLSFO');
      } else {
        addBaseline('VLSFO');
        addBaseline('MGO');
      }

      // fuels
      fuelBody.innerHTML = '';
      (data.fuels || []).forEach(f => {
        addFuel(f.name || 'Custom');
        const last = fuelBody.lastElementChild;
        last.querySelector('.fname').value = f.name || 'Custom';
        last.children[1].querySelector('input').value = f.vol || 0;
        last.children[2].querySelector('select').value = f.mode || 'unit';
        last.children[3].querySelector('.priceOrAnnual').value = f.priceOrAnnual || 0;
        last.children[4].querySelector('input').value = f.ef || 0;
        last.children[5].querySelector('input').value = f.cprice || 0;
        last.children[6].querySelector('input').value = f.slip || 0;
        last.children[7].querySelector('input').value = f.gwp || 27.2;
        toggleSamples(last.querySelector('button.btn.ghost'));
        const tb = last.nextElementSibling.querySelector('tbody'); tb.innerHTML = '';
        (f.samples || []).forEach(v => { const tr = document.createElement('tr'); tr.innerHTML = `<td class='right'></td><td><input type='number' value='${v}' step='1000' min='0'/></td><td><button class='btn' type='button' onclick='this.closest("tr").remove(); recalc();'>ì‚­ì œ</button></td>`; tb.appendChild(tr); });
        [...tb.querySelectorAll('tr')].forEach((row, i) => row.children[0].textContent = i + 1);
        tb.querySelectorAll('input').forEach(inp => inp.addEventListener('input', recalc));
      });

      recalc(); refreshAllVolVisibility();
    }

    // ----- Tests -----
    function runTests() {
      const out = document.getElementById('testOut');
      const logs = [];
      function log(s) { logs.push(s); }

      // (1) unit+avg vs annual+sum (ê¸°ì¡´)
      {
        const r1 = calcCost(10, 'unit', 100, [100, 200, 300], 3, 0, 0, 0);
        const r2 = calcCost(10, 'annual', 100, [100, 200, 300], 3, 0, 0, 0);
        console.assert(Math.round(r1.fuelCost) === 2000, 'unit+avg fuelCost');
        console.assert(Math.round(r2.fuelCost) === 600, 'annual+sum fuelCost');
        log('âœ… unit/annual ìƒ˜í”Œ ì²˜ë¦¬ OK');
      }
      // (2) baseline SUM reference (ê¸°ì¡´)
      {
        const b1 = calcCost(1000, 'unit', 1000, [], 3.114, 0, 0, 27.2);
        const b2 = calcCost(1000, 'unit', 1200, [], 3.206, 0, 0, 27.2);
        const sumFuel = b1.fuelCost + b2.fuelCost; // 2,200,000
        const a = calcCost(1000, 'unit', 1300, [], 2.75, 0, 0.2, 27.2);
        const fuelPremium = a.fuelCost - sumFuel; // -900,000
        console.assert(fuelPremium === (a.fuelCost - sumFuel), 'baseline í•©ê³„ ê¸°ì¤€ í”„ë¦¬ë¯¸ì—„');
        log('âœ… ê¸°ì¤€ í•©ê³„ ëŒ€ë¹„ í”„ë¦¬ë¯¸ì—„ ê³„ì‚° OK');
      }
      // (3) ìŠ¬ë¦½/íƒ„ì†Œë‹¨ê°€ ì˜í–¥ (ê¸°ì¡´)
      {
        const noSlip = calcCost(100, 'unit', 1000, [], 2.75, 100, 0, 27.2);
        const withSlip = calcCost(100, 'unit', 1000, [], 2.75, 100, 0.5, 27.2);
        console.assert(withSlip.carbon > noSlip.carbon, 'ë©”íƒ„ ìŠ¬ë¦½ ì¦ê°€ ì‹œ íƒ„ì†Œë¹„ìš© ì¦ê°€');
        log('âœ… ìŠ¬ë¦½ ë°˜ì˜ OK (carbon up)');
      }
      // (4) hint í‰ê·  ê²€ì¦ (ê¸°ì¡´)
      {
        const r = calcCost(10, 'unit', 100, [100, 200, 300, 400], 3, 0, 0, 27.2);
        console.assert(Math.round(r.hint) === 250, 'hint==avg(samples)');
        log('âœ… hint í‰ê·  ë…¸ì¶œ OK');
      }
      // (5) annual ëª¨ë“œ no-samples (ê¸°ì¡´)
      {
        const r = calcCost(10, 'annual', 123456, [], 3, 0, 0, 27.2);
        console.assert(r.fuelCost === 123456, 'annual without samples uses priceOrAnnual');
        log('âœ… annual no-samples ì²˜ë¦¬ OK');
      }
      // (6) removeBaselineRow ì¡´ì¬ (ê¸°ì¡´)
      {
        console.assert(typeof removeBaselineRow === 'function', 'removeBaselineRow is function');
        log('âœ… removeBaselineRow ì‹œê·¸ë‹ˆì²˜ OK');
      }
      // (7) ì‚¬ìš©ì ì§€ì • ê¸°ë³¸ê°’ (ê¸°ì¡´)
      {
        addBaseline('Custom');
        const trB = baselineBody.lastElementChild;
        const nameB = trB.querySelector('.b-fname').value;
        const volB = +trB.querySelector('.b-vol').value;
        const priceB = +trB.querySelector('.b-priceOrAnnual').value;
        const efB = +trB.querySelector('.b-ef').value;
        const slipB = +trB.querySelector('.b-slip').value;
        const gwpB = +trB.querySelector('.b-gwp').value;
        const cpriceB = +trB.querySelector('.b-cprice').value;
        console.assert(nameB === '' && volB === 0 && priceB === 0 && efB === 0 && slipB === 0 && gwpB === 27.2 && cpriceB === 0, 'Baseline Custom defaults');
        log('âœ… Baseline ì‚¬ìš©ì ì§€ì • ê¸°ë³¸ê°’ OK');

        addFuel('Custom');
        const trF = fuelBody.lastElementChild;
        const nameF = trF.querySelector('.fname').value;
        const volF = +trF.children[1].querySelector('input').value;
        const priceF = +trF.children[3].querySelector('.priceOrAnnual').value;
        const efF = +trF.children[4].querySelector('input').value;
        const cpriceF = +trF.children[5].querySelector('input').value;
        const slipF = +trF.children[6].querySelector('input').value;
        const gwpF = +trF.children[7].querySelector('input').value;
        console.assert(nameF === '' && volF === 0 && priceF === 0 && efF === 0 && cpriceF === 0 && slipF === 0 && gwpF === 27.2, 'Fuel Custom defaults');
        log('âœ… Fuel ì‚¬ìš©ì ì§€ì • ê¸°ë³¸ê°’ OK');
      }
      // (8) GWP ì˜í–¥: ìŠ¬ë¦½ 0ì´ë©´ ì˜í–¥ ì—†ìŒ (ê¸°ì¡´)
      {
        const rA = calcCost(100, 'unit', 1000, [], 2.75, 200, 0, 27.2);
        const rB = calcCost(100, 'unit', 1000, [], 2.75, 200, 0, 50);
        console.assert(rA.carbon === rB.carbon, 'Slip 0 -> GWP ì˜í–¥ ì—†ìŒ');
        log('âœ… Slip 0ì—ì„œ GWP ë¬´ì˜í–¥ í™•ì¸');
      }
      // (9) GWP ì¦ê°€ ì‹œ carbon ì¦ê°€ (ê¸°ì¡´)
      {
        const rA = calcCost(100, 'unit', 1000, [], 2.75, 200, 0.2, 27.2);
        const rB = calcCost(100, 'unit', 1000, [], 2.75, 200, 0.2, 50);
        console.assert(rB.carbon > rA.carbon, 'GWP up -> carbon up');
        log('âœ… GWP ì¦ê°€ íš¨ê³¼ í™•ì¸');
      }
      // (10) ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì˜ˆì™¸ ì—†ì´ ë™ì‘ (ê¸°ì¡´)
      {
        const baseRows = [{ name: 'VLSFO', fuelCost: 100, carbon: 50 }];
        const baseSum = { fuel: 100, carbon: 50 };
        const alts = [{ name: 'LNG', fuelCost: 90, carbon: 30, fuelPremium: -10, carbonSaving: 20 }];
        try { updateCharts(baseRows, baseSum, alts); log('âœ… ì°¨íŠ¸ ì—…ë°ì´íŠ¸ OK'); }
        catch (e) { console.assert(false, 'Chart update failed: ' + e.message); }
      }
      // (11) Hydrogen: EF=0, slip=0 -> carbon==0 (ì‹ ê·œ)
      {
        const r = calcCost(100, 'unit', 1000, [], 0, 300, 0, 27.2);
        console.assert(r.carbon === 0, 'Hydrogen TTW carbon should be 0 when slip=0');
        log('âœ… Hydrogen carbon=0 í™•ì¸');
      }
      // (12) Methanol EF>0 -> carbon>0 (ì‹ ê·œ)
      {
        const r = calcCost(100, 'unit', 1000, [], 1.375, 100, 0, 27.2);
        console.assert(r.carbon > 0, 'Methanol TTW carbon > 0');
        log('âœ… Methanol carbon > 0 í™•ì¸');
      }
      // (13) Market KRW ê³„ì‚° í…ŒìŠ¤íŠ¸ (ì‹ ê·œ)
      {
        document.getElementById('fxUSDKRW').value = 1400; renderMarket();
        const usd = 500; MARKET[0].usd = usd; renderMarket();
        const krwCell = marketBody.querySelectorAll('.m-krw')[0].textContent.replace(/[,\s]/g, '');
        console.assert(+krwCell === usd * 1400, 'í™˜ìœ¨Ã—USD â†’ KRW/mt ê³„ì‚°');
        log('âœ… Market í™˜ìœ¨ í™˜ì‚° OK');
      }

      out.textContent = logs.length ? logs.join('\n') : 'No logs';
    }

    // expose globals for inline onclick handlers
    window.addBaseline = addBaseline;
    window.addFuel = addFuel;
    window.toggleSamples = toggleSamples;
    window.addSampleRow = addSampleRow;
    window.removeBaselineRow = removeBaselineRow;
    window.exportData = exportData;
    window.importData = importData;
    window.runTests = runTests;
    window.addFromMarket = addFromMarket;
    window.computeVolumesFromMarket = computeVolumesFromMarket;

    // ----- Seed initial baseline & alternatives & market -----
    addBaseline('VLSFO');
    addBaseline('MGO');
    addFuel('LNG');
    addFuel('Bio');
    renderMarket();
    renderEnergyTable();
    recomputeAllEffRows();
  </script>
</body>

</html>

<!--
        ê¸°ì¤€(í•©ê³„) íƒ„ì†Œë¹„ìš© ì‚°ì¶œ ê³µì‹:
        ëª¨ë“  ê¸°ì¤€ì—°ë£Œ í–‰ì— ëŒ€í•´ ì•„ë˜ë¥¼ í•©ì‚°í•©ë‹ˆë‹¤.
        
        ê° í–‰ì˜ íƒ„ì†Œë¹„ìš© = (ì—°ê°„ ì‚¬ìš©ëŸ‰ Ã— ë°°ì¶œê³„ìˆ˜ + ì—°ê°„ ì‚¬ìš©ëŸ‰ Ã— (ë©”íƒ„ìŠ¬ë¦½%/100) Ã— GWP) Ã— íƒ„ì†Œë‹¨ê°€
        
        ê¸°ì¤€(í•©ê³„) íƒ„ì†Œë¹„ìš© = Î£ [ (vol Ã— ef + vol Ã— (slip/100) Ã— gwp) Ã— cprice ]
        
        - vol: ì—°ê°„ ì‚¬ìš©ëŸ‰(í†¤)
        - ef: ë°°ì¶œê³„ìˆ˜ (tCOâ‚‚/í†¤)
        - slip: ë©”íƒ„ ìŠ¬ë¦½ (%)
        - gwp: GWP100(CHâ‚„)
        - cprice: íƒ„ì†Œë‹¨ê°€ (â‚©/tCOâ‚‚e)
      -->